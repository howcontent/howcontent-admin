<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 설정 - HowContent Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <!-- 헤더 영역 -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="/">HowContent Admin</a>
            </div>
            <div class="nav-links">
                <a href="/estimate/request.html">견적 요청</a>
                <div class="user-menu">
                    <button class="user-menu-button">
                        <i class="fas fa-user"></i>
                        <span class="user-name">사용자</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown">
                        <a href="/user/profile.html" class="active">프로필 설정</a>
                        <a href="#" id="logoutButton">로그아웃</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- 메인 콘텐츠 -->
    <main class="dashboard">
        <div class="dashboard-container">
            <!-- 사이드바 -->
            <aside class="dashboard-sidebar">
                <nav class="sidebar-nav">
                    <ul>
                        <li>
                            <a href="/user/index.html">
                                <i class="fas fa-home"></i>
                                <span>대시보드</span>
                            </a>
                        </li>
                        <li>
                            <a href="/user/estimates.html">
                                <i class="fas fa-file-invoice"></i>
                                <span>견적 요청 내역</span>
                            </a>
                        </li>
                        <li>
                            <a href="/user/tasks.html">
                                <i class="fas fa-tasks"></i>
                                <span>작업 현황</span>
                            </a>
                        </li>
                        <li>
                            <a href="/user/notifications.html">
                                <i class="fas fa-bell"></i>
                                <span>알림</span>
                                <span class="badge" id="notificationCount">0</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- 메인 콘텐츠 영역 -->
            <div class="dashboard-content">
                <div class="dashboard-section">
                    <h2>프로필 설정</h2>
                    <form id="profileForm" class="profile-form">
                        <div class="form-group">
                            <label for="email" class="form-label">이메일</label>
                            <input type="email" id="email" name="email" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label for="name" class="form-label">이름 *</label>
                            <input type="text" id="name" name="name" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="phone" class="form-label">연락처 *</label>
                            <input type="tel" id="phone" name="phone" class="form-control" 
                                   pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                                   placeholder="예: 010-1234-5678" required>
                        </div>

                        <div class="form-group">
                            <label for="company_name" class="form-label">회사명/상호명</label>
                            <input type="text" id="company_name" name="company_name" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="business_number" class="form-label">사업자등록번호</label>
                            <input type="text" id="business_number" name="business_number" class="form-control"
                                   pattern="[0-9]{3}-[0-9]{2}-[0-9]{5}"
                                   placeholder="예: 123-45-67890">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">프로필 저장</button>
                        </div>
                    </form>
                </div>

                <div class="dashboard-section">
                    <h2>비밀번호 변경</h2>
                    <form id="passwordForm" class="profile-form">
                        <div class="form-group">
                            <label for="current_password" class="form-label">현재 비밀번호 *</label>
                            <div class="password-input">
                                <input type="password" id="current_password" name="current_password" class="form-control" required>
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="new_password" class="form-label">새 비밀번호 *</label>
                            <div class="password-input">
                                <input type="password" id="new_password" name="new_password" class="form-control" 
                                       pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
                                       title="비밀번호는 8자 이상이며, 영문, 숫자, 특수문자를 모두 포함해야 합니다."
                                       required>
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text">8자 이상의 영문, 숫자, 특수문자 조합</small>
                        </div>

                        <div class="form-group">
                            <label for="new_password_confirm" class="form-label">새 비밀번호 확인 *</label>
                            <div class="password-input">
                                <input type="password" id="new_password_confirm" name="new_password_confirm" class="form-control" required>
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">비밀번호 변경</button>
                        </div>
                    </form>
                </div>

                <div class="dashboard-section">
                    <h2>알림 설정</h2>
                    <form id="notificationSettingsForm" class="profile-form">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="email_notifications" checked>
                                <span>이메일 알림 수신</span>
                            </label>
                            <small class="form-text">작업 상태 변경, 댓글 등록 시 이메일로 알림을 받습니다.</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">설정 저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>HowContent Admin</h3>
                <p>쇼핑몰 운영 전문가 그룹</p>
            </div>
            <div class="footer-section">
                <h3>연락처</h3>
                <p>이메일: contact@howcontent.com</p>
                <p>전화: 02-1234-5678</p>
            </div>
            <div class="footer-section">
                <h3>바로가기</h3>
                <a href="/estimate/request.html">견적 요청</a>
                <a href="/login.html">로그인</a>
                <a href="/admin">관리자</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 HowContent Admin. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 세션 체크
            checkSession();
            
            // 사용자 메뉴 토글
            const userMenuButton = document.querySelector('.user-menu-button');
            const userMenuDropdown = document.querySelector('.user-menu-dropdown');
            
            userMenuButton.addEventListener('click', () => {
                userMenuDropdown.classList.toggle('active');
            });
            
            // 로그아웃 처리
            document.getElementById('logoutButton').addEventListener('click', async (e) => {
                e.preventDefault();
                
                try {
                    const response = await fetchData('/api/auth/logout.php', {
                        method: 'POST'
                    });
                    
                    if (response.success) {
                        window.location.href = '/login.html';
                    }
                } catch (error) {
                    showToast('로그아웃 처리 중 오류가 발생했습니다.', 'error');
                }
            });
            
            // 비밀번호 표시/숨김 토글
            const togglePasswordButtons = document.querySelectorAll('.toggle-password');
            togglePasswordButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                });
            });
            
            // 전화번호 자동 하이픈 추가
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', (e) => {
                let number = e.target.value.replace(/[^0-9]/g, '');
                if (number.length > 3 && number.length <= 7) {
                    number = number.substring(0,3) + '-' + number.substring(3);
                } else if (number.length > 7) {
                    number = number.substring(0,3) + '-' + number.substring(3,7) + '-' + number.substring(7);
                }
                e.target.value = number;
            });
            
            // 사업자등록번호 자동 하이픈 추가
            const businessNumberInput = document.getElementById('business_number');
            businessNumberInput.addEventListener('input', (e) => {
                let number = e.target.value.replace(/[^0-9]/g, '');
                if (number.length > 3 && number.length <= 5) {
                    number = number.substring(0,3) + '-' + number.substring(3);
                } else if (number.length > 5) {
                    number = number.substring(0,3) + '-' + number.substring(3,5) + '-' + number.substring(5);
                }
                e.target.value = number;
            });
            
            // 프로필 정보 로드
            loadProfileData();
            
            // 프로필 폼 제출
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (validateForm(this)) {
                    try {
                        const formData = new FormData(this);
                        const response = await fetchData('/api/user/update-profile.php', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.success) {
                            showToast('프로필이 성공적으로 저장되었습니다.', 'success');
                        } else {
                            showToast(response.message || '프로필 저장 중 오류가 발생했습니다.', 'error');
                        }
                    } catch (error) {
                        showToast('서버 오류가 발생했습니다.', 'error');
                    }
                }
            });
            
            // 비밀번호 변경 폼 제출
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('new_password').value;
                const newPasswordConfirm = document.getElementById('new_password_confirm').value;
                
                if (newPassword !== newPasswordConfirm) {
                    showToast('새 비밀번호가 일치하지 않습니다.', 'error');
                    return;
                }
                
                if (validateForm(this)) {
                    try {
                        const formData = new FormData(this);
                        const response = await fetchData('/api/user/change-password.php', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.success) {
                            showToast('비밀번호가 성공적으로 변경되었습니다.', 'success');
                            this.reset();
                        } else {
                            showToast(response.message || '비밀번호 변경 중 오류가 발생했습니다.', 'error');
                        }
                    } catch (error) {
                        showToast('서버 오류가 발생했습니다.', 'error');
                    }
                }
            });
            
            // 알림 설정 폼 제출
            document.getElementById('notificationSettingsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const formData = new FormData(this);
                    const response = await fetchData('/api/user/update-notification-settings.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.success) {
                        showToast('알림 설정이 저장되었습니다.', 'success');
                    } else {
                        showToast(response.message || '알림 설정 저장 중 오류가 발생했습니다.', 'error');
                    }
                } catch (error) {
                    showToast('서버 오류가 발생했습니다.', 'error');
                }
            });
        });

        // 프로필 정보 로드
        async function loadProfileData() {
            try {
                const response = await fetchData('/api/user/profile.php');
                
                if (response.success) {
                    const user = response.user;
                    
                    // 프로필 폼 데이터 설정
                    document.getElementById('email').value = user.email;
                    document.getElementById('name').value = user.name;
                    document.getElementById('phone').value = user.phone;
                    document.getElementById('company_name').value = user.company_name || '';
                    document.getElementById('business_number').value = user.business_number || '';
                    
                    // 알림 설정 데이터 설정
                    document.querySelector('input[name="email_notifications"]').checked = user.email_notifications;
                    
                    // 사용자 이름 표시
                    document.querySelector('.user-name').textContent = user.name;
                }
            } catch (error) {
                showToast('프로필 정보를 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }
    </script>
</body>
</html> 